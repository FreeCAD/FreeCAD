
# ADR-006: Handling of user selected geometry in operations

## Status
DRAFT

## Context
The normal workflow of user in CAM workbench involves applying an operation to features of a model. The user is making two choices
- Which geometry to act upon
- Which action to take on the geometry

However, the order that the user makes the selection has implications on how the UI behaves especially if the UI tries to help the user make appropriate selections.

### Selection styles
When it comes to selection, there are two 'flavors' to consider. The flavors are:


#### **Select->act**
The user selects something to act on and then chooses what action to take.
_CAM example, Select a face and then create a pocket operation._

It is possible to implement a 'selection observer'. The observer runs continuously and constantly evaluates what the user has selected. It can be used to enables/disable tools to guide the user about what actions they can take. For example, if the user selects a vertex, the UI could enable drilling and disable pocket. However, selection gates run continuously and are computationally expensive. Therefore, they _MUST NOT_ be used in this way.

#### **act->select**

The user selects what action to take and then identifies what it will act upon.
_CAM Example, start a facing operation and then pick the target geometry_

In this mode, it's possible to implement a feature called a 'selection gate'. While inside the drilling operation, for example, the UI could restrict the user to only selecting drillable targets.

### Invalid Geometry

When evaluating a user selection geometry, each selection can be considered as one of three types:

#### Valid Selection
A valid selection is one that can be acted on by the operation and meets typical user expectation.
Example, selecting a round or cylindrical feature for drilling
Example, selecting a plane perpendicular to the spindle for pocketing
Example, selecting a text string for engraving.

#### Invalid Selection
An invalid selection is one that the operation is incapable of processing, even if it does meet user expectations.
Example, selecting a vertex for pocketing.
Example, selecting a vertical face for pocketing
Example, selecting a round feature for drilling but the feature is composed of splines.
Example, selecting an apparently closed polygon for pocketing but the polygon is actually open.

### Suspect Selection
A suspect selection is one that the operation is capable of processing but which does not meet typical user expectations.
Example, selecting a vertex for drilling in a model that has typical round and cylindrical features.


## Decision
The CAM user interface will support both flavors simultaneously. The software must be prepared to evaluate the user's selection if it already exists and do the right thing and if it doesn't exist. The user interface will guide the user as much as possible.

Selection observers MUST be used sparingly and only within a transaction.

When an operation initiates, it should evaluate the user selected geometry.

- If no selection exists, the operation logic _MAY_ guess at the target
  geometry from the Job base
- If a selection exists, each item should be evaluated, indepedently.
- If the selection contains invalid items, the operation should raise an error
  and stop.  Example: "The selection contains items that cannot be <drilled/pocketed/vcarved/etc> Please correct the suggestion and try again."
- When the user confirms the notification, the UI state should be restored to the state prior to initiating the command.  The selection should be preserved so the user can modify it.
- If all items in the selection are valid, they should be applied to the operation target geometry.
- No items except the selected items should be added to the target geometry
- Whenever possible in the GUI, selection gates should be used to help the user select correct features.
- In the default configuration, suspect geometry should be treated as invalid.  A permissive selection option may be implemented to allow the experienced user to select atypical geometry.

## Consequences
- Gains: UI feels intuitive.  Strong consistency between operations
- Costs: UI design in operations may be more complex.
