# SPDX-License-Identifier: LGPL-2.1-or-later
# SPDX-FileNotice: Part of the FreeCAD project.

################################################################################
#                                                                              #
#   Copyright (c) 2022 FreeCAD Project Association                             #
#   Copyright (c) 2024 Werner Mayer                                            #
#                                                                              #
#   FreeCAD is free software: you can redistribute it and/or modify            #
#   it under the terms of the GNU Lesser General Public License as             #
#   published by the Free Software Foundation, either version 2.1              #
#   of the License, or (at your option) any later version.                     #
#                                                                              #
#   FreeCAD is distributed in the hope that it will be useful,                 #
#   but WITHOUT ANY WARRANTY; without even the implied warranty                #
#   of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                    #
#   See the GNU Lesser General Public License for more details.                #
#                                                                              #
#   You should have received a copy of the GNU Lesser General Public           #
#   License along with FreeCAD. If not, see https://www.gnu.org/licenses       #
#                                                                              #
################################################################################

"""
Helper module to use pydoc
"""

import os
import sys
import pydoc
import pkgutil

class FreeCADDoc(pydoc.HTMLDoc):
    """
    Custom HTMLDoc for FreeCAD autogenerated python docs.
    """

    def index(self, dir, shadowed=None):
        """ Generate an HTML index for a directory of modules."""
        mod_pkgs = []
        if shadowed is None:
            shadowed = {}

        for importer, name, is_pkg in pkgutil.iter_modules([dir]):
            if name == 'Init':
                continue
            if name == 'InitGui':
                continue
            if name[-2:] == '_d':
                continue
            mod_pkgs.append((name, '', is_pkg, name in shadowed))
            shadowed[name] = 1

        if len(mod_pkgs) == 0:
            return None

        mod_pkgs.sort()
        contents = self.multicolumn(mod_pkgs, self.modpkglink)
        try:
            return self.bigsection(dir, '#ffffff', '#ee77aa', contents)
        except Exception:
            return self.bigsection(dir, 'pkg-content', contents)


def bltinlink(name):
    """Html Link helper."""
    return '<a href=\"%s.html\">%s</a>' % (name, name)


def getIndexOld():
    """[Deprecated] Generate Index."""
    pydoc.html = FreeCADDoc()
    title = 'FreeCAD Python Modules Index'

    heading = pydoc.html.heading('<big><big><strong>Python: Index of Modules</strong></big></big>','#ffffff', '#7799ee')

    names = list(filter(lambda x: x != '__main__', sys.builtin_module_names))
    contents = pydoc.html.multicolumn(names, bltinlink)
    indices = ['<p>' + pydoc.html.bigsection('Built-in Modules', '#ffffff', '#ee77aa', contents)]

    names = ['FreeCAD', 'FreeCADGui']
    contents = pydoc.html.multicolumn(names, bltinlink)
    indices.append('<p>' + pydoc.html.bigsection('Built-in FreeCAD Modules', '#ffffff', '#ee77aa', contents))

    seen = {}
    for dir in sys.path:
        dir = os.path.realpath(dir)
        ret = pydoc.html.index(dir, seen)
        if ret != None:
            indices.append(ret)

    indices_html = " ".join(indices)
    contents = f"""
        {heading}
        {indices_html}
        <p align="right">
            <font color="#909090" face="helvetica, arial">
                <strong>pydoc</strong> by Ka-Ping Yee &lt;ping@lfw.org&gt;
            </font>
        </p>
    """

    return pydoc.html.page(title, contents)


def getIndexNew():
    """Generate Index."""
    pydoc.html = FreeCADDoc()
    title = 'FreeCAD Python Modules Index'

    heading = pydoc.html.heading(
        '<strong class="title">Index of Modules</strong>'
    )

    names = list(filter(lambda x: x != '__main__', sys.builtin_module_names))
    contents = pydoc.html.multicolumn(names, bltinlink)
    indices = ['<p>' + pydoc.html.bigsection('Built-in Modules', 'index', contents)]

    names = ['FreeCAD', 'FreeCADGui']
    contents = pydoc.html.multicolumn(names, bltinlink)
    indices.append('<p>' + pydoc.html.bigsection('Built-in FreeCAD Modules', 'index', contents))

    seen = {}
    for dir in sys.path:
        dir = os.path.realpath(dir)
        ret = pydoc.html.index(dir, seen)
        if ret is not None:
            indices.append(ret)

    indices_html = ' '.join(indices)
    contents = f"""
        {heading}
        {indices_html}
        <p align="right">
            <font color="#909090" face="helvetica, arial">
                <strong>pydoc</strong> by Ka-Ping Yee &lt;ping@lfw.org&gt;
            </font>
        </p>
    """

    return pydoc.html.page(title, contents)


def getIndex():
    """Get Documentation Index."""
    try:
        return getIndexOld()
    except Exception:
        return getIndexNew()


def getPage(page):
    """Get Documentation Page."""
    object, name = pydoc.resolve(page)
    return pydoc.html.page(pydoc.describe(object), pydoc.html.document(object, name))
