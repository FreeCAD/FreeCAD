#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF'
setup-distccd-remote.sh --host <ssh-host> [--jobs N] [--port P] [--allow CIDR ...]
                      [--client-env] [--client-env-file <path>] [--no-client-env] [--dry-run]

Installs and enables a systemd unit for distccd on a remote machine reachable via SSH.

Defaults:
  --jobs 12
  --port 3632
  --allow <this-client-ip/32>
  --client-env (enabled)
  --client-env-file ~/.config/devstack/env.sh

Examples:
  tools/devstack/distcc/setup-distccd-remote.sh --host desktop
  tools/devstack/distcc/setup-distccd-remote.sh --host desktop --allow 192.168.1.0/24
EOF
}

HOST=""
JOBS="12"
PORT="3632"
DRY_RUN="0"
USE_TTY="1"
CLIENT_ENV_ENABLED="1"
CLIENT_ENV_FILE=""
ALLOWS=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    --host) HOST="${2:-}"; shift 2;;
    --jobs) JOBS="${2:-}"; shift 2;;
    --port) PORT="${2:-}"; shift 2;;
    --allow) ALLOWS+=("${2:-}"); shift 2;;
    --dry-run) DRY_RUN="1"; shift;;
    --no-tty) USE_TTY="0"; shift;;
    --client-env) CLIENT_ENV_ENABLED="1"; shift;;
    --no-client-env) CLIENT_ENV_ENABLED="0"; shift;;
    --client-env-file) CLIENT_ENV_FILE="${2:-}"; shift 2;;
    -h|--help) usage; exit 0;;
    *) echo "unknown arg: $1" >&2; usage; exit 2;;
  esac
done

if [[ -z "${HOST}" ]]; then
  echo "--host is required" >&2
  usage
  exit 2
fi

if ! [[ "${JOBS}" =~ ^[0-9]+$ ]] || [[ "${JOBS}" -lt 1 ]]; then
  echo "--jobs must be a positive integer" >&2
  exit 2
fi

if ! [[ "${PORT}" =~ ^[0-9]+$ ]] || [[ "${PORT}" -lt 1 ]] || [[ "${PORT}" -gt 65535 ]]; then
  echo "--port must be 1..65535" >&2
  exit 2
fi

if [[ "${CLIENT_ENV_ENABLED}" == "1" ]]; then
  if [[ -z "${CLIENT_ENV_FILE}" ]]; then
    CLIENT_ENV_PATH="${HOME}/.config/devstack/env.sh"
  else
    CLIENT_ENV_PATH="${CLIENT_ENV_FILE/#~/${HOME}}"
  fi
else
  CLIENT_ENV_PATH=""
fi

if [[ ${#ALLOWS[@]} -eq 0 ]]; then
  CLIENT_IP="$(ip -o route get 1.1.1.1 2>/dev/null | awk '{for (i=1;i<=NF;i++) if ($i=="src") {print $(i+1); exit}}')"
  if [[ -z "${CLIENT_IP}" ]]; then
    echo "failed to detect client IP; pass --allow <cidr> explicitly" >&2
    exit 2
  fi
  ALLOWS+=("${CLIENT_IP}/32")
fi

ALLOW_ARGS=()
for cidr in "${ALLOWS[@]}"; do
  if [[ -z "${cidr}" ]]; then
    continue
  fi
  ALLOW_ARGS+=("--allow" "${cidr}")
done

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
UNIT_TEMPLATE="${SCRIPT_DIR}/distccd.service.in"
if [[ ! -f "${UNIT_TEMPLATE}" ]]; then
  echo "missing unit template: ${UNIT_TEMPLATE}" >&2
  exit 1
fi

ALLOW_ESCAPED=""
for ((i=0; i<${#ALLOW_ARGS[@]}; i++)); do
  part="${ALLOW_ARGS[$i]}"
  part="${part//\\/\\\\}"
  part="${part//\"/\\\"}"
  ALLOW_ESCAPED+="${part} "
done
ALLOW_ESCAPED="${ALLOW_ESCAPED% }"

UNIT_CONTENT="$(cat "${UNIT_TEMPLATE}")"
UNIT_CONTENT="${UNIT_CONTENT//@PORT@/${PORT}}"
UNIT_CONTENT="${UNIT_CONTENT//@JOBS@/${JOBS}}"
UNIT_CONTENT="${UNIT_CONTENT//@ALLOW_ARGS@/${ALLOW_ESCAPED}}"

REMOTE_UNIT_PATH="/etc/systemd/system/distccd.service"

REMOTE_SCRIPT=$(cat <<EOF
set -euo pipefail
if [[ "${USE_TTY}" == "0" ]]; then
  sudo -n true
else
  sudo true
fi
sudo apt-get update -y
sudo apt-get install -y distcc clang
if ! id -u distcc >/dev/null 2>&1; then
  sudo useradd --system --no-create-home --shell /usr/sbin/nologin distcc
fi
cat <<'UNIT' | sudo tee '${REMOTE_UNIT_PATH}' >/dev/null
${UNIT_CONTENT}
UNIT
sudo systemctl daemon-reload
sudo systemctl enable --now distccd.service
sudo systemctl --no-pager --full status distccd.service
EOF
)

if [[ "${DRY_RUN}" == "1" ]]; then
  echo "Would run on ${HOST}:"
  echo "${REMOTE_SCRIPT}"
  exit 0
fi

SSH_OPTS=()
if [[ "${USE_TTY}" == "1" ]]; then
  SSH_OPTS+=("-t")
fi
ssh "${SSH_OPTS[@]}" "${HOST}" "bash -lc $(printf '%q' "${REMOTE_SCRIPT}")"

DISTCC_HOSTS_VALUE="${HOST}:${PORT}/${JOBS}"

if [[ "${CLIENT_ENV_ENABLED}" == "1" ]]; then
  mkdir -p "$(dirname -- "${CLIENT_ENV_PATH}")"
  cat >"${CLIENT_ENV_PATH}" <<EOF
# Generated by tools/devstack/distcc/setup-distccd-remote.sh
#
# This file is sourced by tools/devstack/devstack.py (if present).
#
# shellcheck shell=bash

export DISTCC_HOSTS="${DISTCC_HOSTS_VALUE}"
export DEVSTACK_AUTO_DISTCC=1
export CCACHE_PREFIX=distcc
export CCACHE_CPP2=yes
EOF
  echo
  echo "Wrote devstack env file: ${CLIENT_ENV_PATH}"
fi


echo
echo "Client env (run on your machine):"
echo "  export DISTCC_HOSTS=\"${HOST}:${PORT}/${JOBS}\""
echo "  export CCACHE_PREFIX=distcc"
echo "  export CCACHE_CPP2=yes"
